package com.tygas.tianyu.tianyu.ui.view.activity;

import android.app.Activity;
import android.app.ActivityManager;
import android.app.AlertDialog;
import android.app.Notification;
import android.app.NotificationManager;
import android.app.ProgressDialog;
import android.content.Context;
import android.content.DialogInterface;
import android.content.Intent;
import android.content.pm.PackageInfo;
import android.content.pm.PackageManager;
import android.net.Uri;
import android.os.Bundle;
import android.os.Environment;
import android.util.Log;
import android.view.View;
import android.widget.ImageView;
import android.widget.LinearLayout;
import android.widget.RemoteViews;
import android.widget.TextView;

import com.lidroid.xutils.DbUtils;
import com.lidroid.xutils.HttpUtils;
import com.lidroid.xutils.exception.DbException;
import com.lidroid.xutils.exception.HttpException;
import com.lidroid.xutils.http.ResponseInfo;
import com.lidroid.xutils.http.callback.RequestCallBack;
import com.lidroid.xutils.http.client.HttpRequest;
import com.tygas.tianyu.tianyu.R;
import com.tygas.tianyu.tianyu.context.MyAppCollection;
import com.tygas.tianyu.tianyu.data.SharedPreferencesDate;
import com.tygas.tianyu.tianyu.data.UrlData;
import com.tygas.tianyu.tianyu.service.UpVersonService;
import com.tygas.tianyu.tianyu.ui.model.PID;
import com.tygas.tianyu.tianyu.ui.model.User;
import com.tygas.tianyu.tianyu.ui.model.UserPtInfoModel;
import com.tygas.tianyu.tianyu.utils.DbUtilsHelper;
import com.tygas.tianyu.tianyu.utils.HttpUtilsHelper;
import com.tygas.tianyu.tianyu.utils.SystemBarUtils;
import com.tygas.tianyu.tianyu.utils.XutilsRequest;

import java.io.File;
import java.util.List;


public class MainActivity extends Activity {

    private ImageView iv_ptcustomers;
    private ImageView iv_clue;
    private ImageView iv_cpcustomers;
    private TextView tv_zhanghao;
    private static final String PT_LIST = "AndroidApp_search_customer";
    private static final String CLUE_LIST = "AndroidApp_search_clue";
    private static final String CP_LIST = "AndroidApp_search_customer_list";

    private DbUtils dbUtils;


    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        SystemBarUtils.setSystemBarColor(this, "#327ECA");
        setContentView(R.layout.activity_main);
        dbUtils = DbUtilsHelper.newInstance(this);
        initView();
        //   getUrlPackageCode();
        getUrlPackageCode();

    }

    private void initView() {
        iv_ptcustomers = (ImageView) findViewById(R.id.activity_main_iv_ptcustomers);
        iv_clue = (ImageView) findViewById(R.id.activity_main_iv_clue);
        iv_cpcustomers = (ImageView) findViewById(R.id.activity_main_iv_cp);
        tv_zhanghao = (TextView) findViewById(R.id.activity_main_tv_zhanghao);
        tv_zhanghao.setText("账号:  " + getSharedPreferences(SharedPreferencesDate.SHAREDPREFERENCES_NAME_USERINFO, MODE_PRIVATE).getString(SharedPreferencesDate.USER_NAME, ""));
        try {
            List<PID> list_pid = dbUtils.findAll(PID.class);
            Log.d("adadada", list_pid.toString());
            for (PID pid : list_pid) {
                switch (pid.getFormID()) {
                    case PT_LIST:
                        iv_ptcustomers.setVisibility(View.VISIBLE);
                        break;
                    case CLUE_LIST:
                        iv_clue.setVisibility(View.VISIBLE);
                        break;
                    case CP_LIST:
                        iv_cpcustomers.setVisibility(View.VISIBLE);
                        break;
                }
            }
        } catch (DbException e) {
            e.printStackTrace();
        }


    }

    public void listOnclick(View view) {
        switch (view.getId()) {
            case R.id.activity_main_iv_ptcustomers:
                Intent intent = new Intent(MainActivity.this, PtCustomersActivity.class);
                startActivity(intent);
                break;
            case R.id.activity_main_iv_cp:
                Intent intent_cp = new Intent(MainActivity.this, CpCustomActivity.class);
                startActivity(intent_cp);
                break;

            case R.id.activity_main_tv_exit:
                Intent intent_login = new Intent(MainActivity.this, LoginActivity.class);
                startActivity(intent_login);
                getSharedPreferences(SharedPreferencesDate.SHAREDPREFERENCES_NAME_USERINFO, MODE_PRIVATE).edit().putBoolean(SharedPreferencesDate.ISLOGIN, false).commit();
                try {
                    dbUtils.deleteAll(User.class);
                    dbUtils.deleteAll(UserPtInfoModel.class);
                    dbUtils.deleteAll(PID.class);
                } catch (DbException e) {
                    e.printStackTrace();
                }

                finish();
                break;
        }
    }

    @Override
    protected void onDestroy() {
        super.onDestroy();

    }

    public static final String URL = "http://music.baidu.com/cms/BaiduMusic-danqu.apk";


    private void getUrlPackageCode() {
        HttpUtilsHelper.httpUtils.send(HttpRequest.HttpMethod.POST, UrlData.VERSON_URL, XutilsRequest.getVersonCode(), new RequestCallBack<Object>() {
            @Override
            public void onSuccess(ResponseInfo<Object> responseInfo) {
                Log.i("veron", responseInfo.result.toString());
                try {
                    int versionCode = MainActivity.this.getPackageManager().getPackageInfo(getPackageName(), 0).versionCode;
                    if (versionCode < 2) {
                        //发现新版本，提示用户更新
                        AlertDialog.Builder alert = new AlertDialog.Builder(MainActivity.this);
                        alert.setTitle("软件升级")
                                .setMessage("发现新版本,建议立即更新使用.")
                                .setPositiveButton("更新", new DialogInterface.OnClickListener() {
                                    public void onClick(DialogInterface dialog, int which) {
                                        //开启更新服务UpdateService
                                        //这里为了把update更好模块化，可以传一些updateService依赖的值
                                        //如布局ID，资源ID，动态获取的标题,这里以app_name为例
                                        Intent updateIntent = new Intent(MainActivity.this, UpVersonService.class);
                                        updateIntent.putExtra("app_name", R.string.app_name);
                                        updateIntent.putExtra("downurl", URL);
                                        startService(updateIntent);
                                    }
                                })
                                .setNegativeButton("取消", new DialogInterface.OnClickListener() {
                                    public void onClick(DialogInterface dialog, int which) {
                                        dialog.dismiss();
                                    }
                                });
                        if (getSharedPreferences(SharedPreferencesDate.SHAREDPREFERENCES_NAME_USERINFO, MODE_PRIVATE).getBoolean(SharedPreferencesDate.ISLOGIN, false)) {
                            alert.create().show();
                        }


                    } else {
                        //清理工作，略去
                        //cheanUpdateFile(),文章后面我会附上代码
                    }
                } catch (PackageManager.NameNotFoundException e) {
                    e.printStackTrace();
                }


            }

            @Override
            public void onFailure(HttpException e, String s) {
                Log.i("veron", s);
            }
        });
    }


}
