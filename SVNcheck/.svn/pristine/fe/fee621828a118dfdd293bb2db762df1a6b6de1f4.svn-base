package com.tygas.tianyu.tianyu.context;

import android.content.ContentResolver;
import android.content.Context;
import android.database.Cursor;
import android.media.AudioManager;
import android.media.MediaPlayer;
import android.media.MediaRecorder;
import android.provider.CallLog;
import android.telephony.PhoneStateListener;
import android.telephony.TelephonyManager;
import android.util.Log;
import android.widget.Toast;

import com.czt.mp3recorder.MP3Recorder;
import com.tygas.tianyu.tianyu.utils.RecordFile;

import java.io.File;
import java.lang.reflect.Field;


/**
 * Created by SJTY_YX on 2016/1/25.
 */
public class PhonStateLisen extends PhoneStateListener {

    private static final String LOG_TAG = "PhonStateLisen";
    private boolean isCall = false;
    //private MediaRecorder mediaRecorder;

    MP3Recorder mediaRecorder;// = new MP3Recorder(new File(Environment.getExternalStorageDirectory(),"test.mp3"));

    private File file;
    private Context context;

    private String phoneNumber;//其实是文件名 时间 hh:mm:ss

    public PhonStateLisen(Context context) {
        this.context = context;
    }

    public String getPhoneNumber() {
        return phoneNumber;
    }

    public void setPhoneNumber(String phoneNumber) {
        this.phoneNumber = phoneNumber;
    }

    @Override
    public void onCallStateChanged(int state, String incomingNumber) {
        switch (state){
            case TelephonyManager.CALL_STATE_IDLE://电话挂断
                Log.i(LOG_TAG,"[电话挂断] incomingNumber "+incomingNumber);
                if(isCall){
                    /*if(readThread!=null){
                        readThread.isRun = false;
                    }*/
                    phoneNumber = null;
                    //结束录音服务
                    if(mediaRecorder != null){
                        Log.i(LOG_TAG,"[录音结束]");
                        Toast.makeText(context,"录音结束",Toast.LENGTH_SHORT).show();
                        mediaRecorder.stop();
                        mediaRecorder = null;
                    }
                }
                isCall = false;
                break;
            case TelephonyManager.CALL_STATE_OFFHOOK://电话链接
                Log.i(LOG_TAG,"[电话链接] incomingNumber "+incomingNumber);
                if(phoneNumber != null){
                    isCall = true;
                    /*readThread = new ReadThread(context);
                    readThread.start();*/
                }
                if(isCall){
                    //启动录音服务
                    Toast.makeText(context, "开始录音", Toast.LENGTH_SHORT).show();
                    RecordFile recordFile = new RecordFile(context,phoneNumber);
                    file = recordFile.getRecordFile();

                    Log.i(LOG_TAG,"[录音输出的文件]"+file.getAbsolutePath());

                    mediaRecorder = new MP3Recorder(file);

                    /*Class clazz = MP3Recorder.class;
                    try {
                        Field f = clazz.getDeclaredField("DEFAULT_AUDIO_SOURCE");
                        f.setInt(mediaRecorder,MediaRecorder.AudioSource.VOICE_CALL);
                    } catch (NoSuchFieldException e) {
                        e.printStackTrace();
                    } catch (IllegalAccessException e) {
                        e.printStackTrace();
                    }*/
                    
                    try {
                        mediaRecorder.start();
                    } catch (Exception e) {
                        e.printStackTrace();
                        Log.i(LOG_TAG,"[错误]"+e);
                    }
                }
                break;
            case TelephonyManager.CALL_STATE_RINGING://电话响铃
                Log.i(LOG_TAG,"[电话响铃] incomingNumber "+incomingNumber);
                break;
        }
    }
}
