package com.tygas.tianyu.tianyu.ui.view.activity;

import android.app.Activity;
import android.app.ActivityManager;
import android.app.AlertDialog;
import android.app.Notification;
import android.app.NotificationManager;
import android.app.ProgressDialog;
import android.content.Context;
import android.content.DialogInterface;
import android.content.Intent;
import android.content.pm.PackageInfo;
import android.content.pm.PackageManager;
import android.net.Uri;
import android.os.Bundle;
import android.os.Environment;
import android.os.Handler;
import android.os.Message;
import android.util.Log;
import android.view.Gravity;
import android.view.KeyEvent;
import android.view.MotionEvent;
import android.view.View;
import android.view.ViewGroup;
import android.widget.ImageView;
import android.widget.LinearLayout;
import android.widget.PopupWindow;
import android.widget.RemoteViews;
import android.widget.TextView;
import android.widget.Toast;

import com.lidroid.xutils.DbUtils;
import com.lidroid.xutils.HttpUtils;
import com.lidroid.xutils.exception.DbException;
import com.lidroid.xutils.exception.HttpException;
import com.lidroid.xutils.http.ResponseInfo;
import com.lidroid.xutils.http.callback.RequestCallBack;
import com.lidroid.xutils.http.client.HttpRequest;
import com.tygas.tianyu.tianyu.R;
import com.tygas.tianyu.tianyu.context.MyAppCollection;
import com.tygas.tianyu.tianyu.data.SharedPreferencesDate;
import com.tygas.tianyu.tianyu.data.UrlData;
import com.tygas.tianyu.tianyu.service.UpVersonService;
import com.tygas.tianyu.tianyu.ui.model.PID;
import com.tygas.tianyu.tianyu.ui.model.User;
import com.tygas.tianyu.tianyu.ui.model.UserPtInfoModel;
import com.tygas.tianyu.tianyu.utils.DbUtilsHelper;
import com.tygas.tianyu.tianyu.utils.HttpUtilsHelper;
import com.tygas.tianyu.tianyu.utils.JsonParser;
import com.tygas.tianyu.tianyu.utils.SystemBarUtils;
import com.tygas.tianyu.tianyu.utils.XutilsRequest;

import java.io.File;
import java.util.List;


public class MainActivity extends Activity {

    private ImageView iv_ptcustomers;
    private ImageView iv_clue;
    private ImageView iv_cpcustomers;
    private TextView tv_zhanghao;
    private static final String PT_LIST = "AndroidApp_search_customer";
    private static final String CLUE_LIST = "AndroidApp_search_clue";
    private static final String CP_LIST = "AndroidApp_repair_customer";

    private DbUtils dbUtils;
    private User user;
    private PopupWindow popupWindow;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        SystemBarUtils.setSystemBarColor(this, "#327ECA");
        setContentView(R.layout.activity_main);
        dbUtils = DbUtilsHelper.newInstance(this);
        user = ((MyAppCollection) getApplicationContext()).getUser();
        initView();
        //   getUrlPackageCode();
        getUrlPackageCode();

    }

    private void initView() {
        iv_ptcustomers = (ImageView) findViewById(R.id.activity_main_iv_ptcustomers);
        iv_clue = (ImageView) findViewById(R.id.activity_main_iv_clue);
        iv_cpcustomers = (ImageView) findViewById(R.id.activity_main_iv_cp);
        tv_zhanghao = (TextView) findViewById(R.id.activity_main_tv_zhanghao);
        tv_zhanghao.setText(((MyAppCollection) getApplicationContext()).getUser().getEmpName());
        try {
            List<PID> list_pid = dbUtils.findAll(PID.class);
            Log.d("adadada", list_pid.toString());
            for (PID pid : list_pid) {
                switch (pid.getFormID()) {
                    case PT_LIST:
                        iv_ptcustomers.setVisibility(View.VISIBLE);
                        break;
                    case CLUE_LIST:
                        iv_clue.setVisibility(View.VISIBLE);
                        break;
                    case CP_LIST:
                        iv_cpcustomers.setVisibility(View.VISIBLE);
                        break;
                }
            }
        } catch (DbException e) {
            e.printStackTrace();
        }


    }


    public void listOnclick(View view) {
        switch (view.getId()) {
            case R.id.activity_main_iv_ptcustomers:
                Intent intent = new Intent(MainActivity.this, PtCustomersActivity.class);
                startActivity(intent);
                break;
            case R.id.activity_main_iv_cp:
                Intent intent_cp = new Intent(MainActivity.this, CpCustomActivity.class);
                startActivity(intent_cp);
                break;
            case R.id.activity_main_iv_clue:
                Intent intent_c = new Intent(MainActivity.this, ClueActivity.class);
                startActivity(intent_c);
                break;
            case R.id.activity_main_tv_exit:
                Intent intent_login = new Intent(MainActivity.this, LoginActivity.class);
                startActivity(intent_login);
                getSharedPreferences(SharedPreferencesDate.SHAREDPREFERENCES_NAME_USERINFO, MODE_PRIVATE).edit().putBoolean(SharedPreferencesDate.ISLOGIN, false).commit();
                try {
                    dbUtils.deleteAll(User.class);
                    dbUtils.deleteAll(UserPtInfoModel.class);
                    dbUtils.deleteAll(PID.class);
                } catch (DbException e) {
                    e.printStackTrace();
                }
                finish();
                break;
            case R.id.activity_cpinfo_user_icon:
                // TODO Auto-generated method stub
                // 获取自定义布局文件activity_popupwindow_left.xml的视图

//                View popupWindow_view = getLayoutInflater().inflate(R.layout.user_info_popwindow, null, false);
//                TextView id = (TextView) popupWindow_view.findViewById(R.id.pop_id);
//                id.setText(user.getEmpId());
//                TextView name = (TextView) popupWindow_view.findViewById(R.id.pop_name);
//                name.setText(user.getEmpName());
//
//                // 创建PopupWindow实例,200,LayoutParams.MATCH_PARENT分别是宽度和高度
//                popupWindow = new PopupWindow(popupWindow_view, ViewGroup.LayoutParams.WRAP_CONTENT, ViewGroup.LayoutParams.WRAP_CONTENT, true);
//                // popupWindow_view.setBackground();
//                // 设置动画效果
//                //  popupWindow[0].setAnimationStyle(R.style.AnimationFade);
//                if (popupWindow.isShowing()) {
//                    popupWindow.dismiss();
//                } else {
//                    popupWindow.showAsDropDown(view);
//                }


                break;
        }
    }

    @Override
    protected void onDestroy() {
        super.onDestroy();

    }

    public static final String URL = "http://music.baidu.com/cms/BaiduMusic-danqu.apk";


    private void getUrlPackageCode() {
        HttpUtilsHelper.httpUtils.send(HttpRequest.HttpMethod.POST, UrlData.VERSON_URL, XutilsRequest.getVersonCode(), new RequestCallBack<Object>() {
            @Override
            public void onSuccess(ResponseInfo<Object> responseInfo) {
                Log.i("veron", responseInfo.result.toString());
                final Bundle bundle = JsonParser.versionCodeParser(responseInfo.result.toString());
                Log.d("bundle", bundle.toString());
                try {
                    final int versionCode = MainActivity.this.getPackageManager().getPackageInfo(getPackageName(), 0).versionCode;
                    if (versionCode <
                            Integer.parseInt(bundle.getString("APPVersion"))
                            ) {
                        //发现新版本，提示用户更新
                        final String appDownLoadPath = bundle.getString("APPDownLoadPath");
                        AlertDialog.Builder alert = new AlertDialog.Builder(MainActivity.this);
                        alert.setCancelable(false);
                        alert.setTitle("软件升级")
                                .setMessage("发现新版本,建议立即更新使用.")
                                .setPositiveButton("更新", new DialogInterface.OnClickListener() {
                                    public void onClick(DialogInterface dialog, int which) {
                                        //开启更新服务UpdateService

                                        //这里为了把update更好模块化，可以传一些updateService依赖的值
                                        //如布局ID，资源ID，动态获取的标题,这里以app_name为例
                                        Intent updateIntent = new Intent(MainActivity.this, UpVersonService.class);
                                        updateIntent.putExtra("app_name", appDownLoadPath.substring(appDownLoadPath.lastIndexOf("/") + 1));
                                        Log.d("ssnamename", appDownLoadPath.substring(appDownLoadPath.lastIndexOf("/") + 1));
                                        updateIntent.putExtra("downurl", appDownLoadPath);
                                        startService(updateIntent);
                                    }
                                })
                                .setNegativeButton("取消", new DialogInterface.OnClickListener() {
                                    public void onClick(DialogInterface dialog, int which) {
                                        dialog.dismiss();
                                    }
                                });
                        if (getSharedPreferences(SharedPreferencesDate.SHAREDPREFERENCES_NAME_USERINFO, MODE_PRIVATE).getBoolean(SharedPreferencesDate.ISLOGIN, false)) {
                            alert.create().show();
                        }


                    } else {
                        //清理工作，略去
                        //cheanUpdateFile(),文章后面我会附上代码
                    }
                } catch (PackageManager.NameNotFoundException e) {
                    e.printStackTrace();
                }


            }

            @Override
            public void onFailure(HttpException e, String s) {
                Log.i("veron", s);
            }
        });
    }

    // 定义一个变量，来标识是否退出
    private static boolean isExit = false;

    Handler mHandler = new Handler() {

        @Override
        public void handleMessage(Message msg) {
            super.handleMessage(msg);
            isExit = false;
        }
    };

    @Override
    public boolean onKeyDown(int keyCode, KeyEvent event) {
        if (keyCode == KeyEvent.KEYCODE_BACK) {
            exit();
            return false;
        }
        return super.onKeyDown(keyCode, event);
    }

    private void exit() {
        if (!isExit) {
            isExit = true;
            Toast.makeText(getApplicationContext(), "再按一次退出程序",
                    Toast.LENGTH_SHORT).show();
            // 利用handler延迟发送更改状态信息
            mHandler.sendEmptyMessageDelayed(0, 2000);
        } else {
            finish();
            System.exit(0);
        }
    }

}
