package com.tygas.tianyu.tianyu.ui.view.activity;

import android.content.Intent;
import android.content.SharedPreferences;
import android.graphics.Color;
import android.os.Bundle;
import android.preference.PreferenceManager;
import android.support.v7.app.AppCompatActivity;
import android.util.Log;
import android.view.View;
import android.view.ViewGroup;
import android.widget.AdapterView;
import android.widget.GridView;
import android.widget.ImageView;

import com.lidroid.xutils.HttpUtils;
import com.lidroid.xutils.exception.HttpException;
import com.lidroid.xutils.http.RequestParams;
import com.lidroid.xutils.http.ResponseInfo;
import com.lidroid.xutils.http.callback.RequestCallBack;
import com.lidroid.xutils.http.client.HttpRequest;
import com.tygas.tianyu.tianyu.R;
import com.tygas.tianyu.tianyu.ui.adapter.PersonHomeAdapter;
import com.tygas.tianyu.tianyu.ui.model.UserKPI;
import com.tygas.tianyu.tianyu.ui.view.customview.FocuGirdView;
import com.tygas.tianyu.tianyu.utils.HttpUtilsHelper;
import com.tygas.tianyu.tianyu.utils.XutilsRequest;

import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

import java.util.ArrayList;

/**
 * Created by SJTY_YX on 2016/3/15.
 *
 * 个人工作主页
 *
 */
public class PersonHomePageActivity extends AppCompatActivity implements View.OnClickListener, AdapterView.OnItemClickListener {

    private ImageView backImageView;//返回按钮
    private ImageView addImageView;//底部的添加按钮
    private GridView contentFocuGirdView;//

    private ArrayList<UserKPI> showKpis = new ArrayList<>();//需要显示的kpi
    private ArrayList<UserKPI> allKpis = new ArrayList<>();//全部的kpi

    private PersonHomeAdapter adapter;

    private static final int UP_COLOR = Color.rgb(32,123,3);//增长的字体颜色 绿色
    private static final int DOWN_COLOR = Color.rgb(246,5,22);//下降的字体颜色 红色

    private static final String LOG_TAG = "PersonHomePageActivity";
    public static final String SAVE_TAG = "userkpishow";//应该显示那些userkpi

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_personhomepage);
        initView();
        initUserKPI();
        initData();
    }//end onCreatea

    private void initUserKPI() {
        adapter = new PersonHomeAdapter(showKpis);
        contentFocuGirdView.setAdapter(adapter);
        SharedPreferences ps = PreferenceManager.getDefaultSharedPreferences(this);
        String kpi = ps.getString(SAVE_TAG, "");
        showKpis.clear();
        if(!"".equals(kpi)){
            allKpis.clear();
            String[] kpis = kpi.split(",");
            for(int i=0;i<kpis.length;i++){
                UserKPI userKPI = new UserKPI();
                userKPI.setTitle(kpis[i].substring(0,kpis[i].length()-1));
                if(kpis[i].endsWith("F")){//不显示
                    userKPI.setIsShow(false);
                }else{//显示
                    userKPI.setIsShow(true);
                    showKpis.add(userKPI);
                }
                allKpis.add(userKPI);
            }
            adapter.notifyDataSetChanged();
        }
    }

    @Override
    protected void onRestart() {
        super.onRestart();
        initUserKPI();
        initData();
    }

    private void initData() {
        showProgress();
        String empid = "1";
        RequestParams requestParams = XutilsRequest.getUserKpiRequestParams("", empid);
        HttpUtils instance = HttpUtilsHelper.getInstance();
        instance.send(HttpRequest.HttpMethod.POST, "http://118.123.249.59:1999/OS/OpenService/App.aspx?type=userkpi"/*UrlData.USERKPI_URL*/, requestParams, new RequestCallBack<String>() {
            @Override
            public void onSuccess(ResponseInfo<String> responseInfo) {
                try {
                    parseKpiResult(responseInfo.result);
                    hidenProgress();
                } catch (JSONException e) {
                    e.printStackTrace();
                }
            }

            @Override
            public void onFailure(HttpException e, String s) {
                hidenProgress();
                Log.i(LOG_TAG, "[网络请求错误]" + s);
            }
        });

    }//end initData

    //{"status":"Success","message":"","data":"{\"UserKPIList\":[{\"title\":\"当前库存数\",\"Num\":0},{\"title\":\"库存深度\",\"Num\":0},{\"title\":\"在途数\",\"Num\":0},{\"title\":\"在跟线索数\",\"Num\":7},{\"title\":\"在跟H级线索数\",\"Num\":1},{\"title\":\"在跟A级线索数\",\"Num\":1},{\"title\":\"在跟B级线索数\",\"Num\":2},{\"title\":\"在跟C级线索数\",\"Num\":2},{\"title\":\"在跟FR级线索数\",\"Num\":1},{\"title\":\"在跟H级潜客数 \",\"Num\":56},{\"title\":\"在跟A级潜客数\",\"Num\":5},{\"title\":\"在跟B级潜客数\",\"Num\":48},{\"title\":\"在跟C级潜客数\",\"Num\":32},{\"title\":\"在跟FR级潜客数\",\"Num\":8},{\"title\":\"当前未成交订单\",\"Num\":0},{\"title\":\"当前被驳回按揭\",\"Num\":0},{\"title\":\"结算未交车\",\"Num\":0}],\"totalrows\":0}"}
    private void parseKpiResult(String result) throws JSONException {
        JSONObject jsonObject = new JSONObject(result);
        String status = jsonObject.getString("status");
        if("Success".equals(status)){
            String dataStr = jsonObject.getString("data");
            jsonObject = new JSONObject(dataStr);
            JSONArray arr = jsonObject.getJSONArray("UserKPIList");
            ArrayList<UserKPI> temp = new ArrayList<>();
            Log.i(LOG_TAG,"[all kpis before]"+allKpis);
            for(int i = 0;i < arr.length();i++){
                JSONObject obj = arr.getJSONObject(i);
                UserKPI userKPI = new UserKPI();
                userKPI.setTitle(obj.getString("title"));
                userKPI.setIsShow(true);
                userKPI.setNum(obj.getString("Num"));
                for(int j=0;j<allKpis.size();j++){
                    if(userKPI.getTitle().equals(allKpis.get(j).getTitle())){
                        userKPI.setIsShow(allKpis.get(j).isShow());
                    }
                }//end for
                temp.add(userKPI);
            }//end for
            allKpis = temp;
            //写入shareprefences
            saveToFile(allKpis);
            //获取到adapter
            temp = new ArrayList<>();
            for(int i=0;i<allKpis.size();i++){
                if(allKpis.get(i).isShow()){
                    temp.add(allKpis.get(i));
                }
            }
            showKpis.clear();
            showKpis.addAll(temp);
            adapter.notifyDataSetChanged();
            //contentFocuGirdView.invalidate();
        }
    }//end parseKpiResult

    private void saveToFile(ArrayList<UserKPI> allKpis) {
        String result = "";
        for(int i=0;i<allKpis.size();i++){
            result += allKpis.get(i).toString()+",";
        }
        result = result.endsWith(",")? result.substring(0,result.length()) : result;
        SharedPreferences ps = PreferenceManager.getDefaultSharedPreferences(this);
        SharedPreferences.Editor editor = ps.edit();
        editor.putString(SAVE_TAG,result);
        editor.commit();
    }//end saveToFile

    private void initView() {
        addImageView = (ImageView) findViewById(R.id.activity_personhomepage_iv_add);
        contentFocuGirdView = (GridView) findViewById(R.id.activity_personhomepage_focugirdview_content);
        addImageView.setOnClickListener(this);
        contentFocuGirdView.setOnItemClickListener(this);
        backImageView = (ImageView) findViewById(R.id.activity_personhomepage_iv_back);
        backImageView.setOnClickListener(this);
    }//end initView

    private void showProgress(){
        handelProgress(View.VISIBLE);
    }

    private void hidenProgress(){
        handelProgress(View.GONE);
    }

    private void handelProgress(int what){
        if(contentFocuGirdView != null){
            //contentFocuGirdView
            for(int i=0;i<contentFocuGirdView.getChildCount();i++){
                ViewGroup view = (ViewGroup) contentFocuGirdView.getChildAt(i);
                ViewGroup temp = (ViewGroup) view.getChildAt(1);
                temp.getChildAt(0).setVisibility(what);
            }
        }
    }

    @Override
    public void onClick(View v) {
        switch (v.getId()){
            case R.id.activity_personhomepage_iv_back:
                finish();
                break;
           case R.id.activity_personhomepage_iv_add:
                Intent intent = new Intent();
                intent.setClass(this,PersonHomeShowSetAvtivity.class);
                startActivity(intent);
                break;
        }
    }

    @Override
    public void onItemClick(AdapterView<?> parent, View view, int position, long id) {
    }
}
